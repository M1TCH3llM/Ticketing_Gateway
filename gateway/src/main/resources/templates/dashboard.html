<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" data-bs-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ticketing Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body class="bg-dark text-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-black border-bottom border-secondary">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="/dashboard">Ticketing</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
            aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/health">Health</a></li>
        <li class="nav-item"><a class="nav-link active" href="/dashboard">Dashboard</a></li>
      </ul>
      <div class="d-flex align-items-center gap-3">
        <span class="text-secondary small">Signed in as
          <span id="username" class="text-white fw-semibold" th:text="${username}">user</span>
        </span>
        <a class="btn btn-outline-light btn-sm" href="/logout">Logout</a>
      </div>
    </div>
  </div>
</nav>

<main class="container py-4">
  <!-- Role sections -->
  <div class="card bg-dark border-secondary shadow-sm mt-4" sec:authorize="hasRole('USER')">
    <div class="card-body">
      <h5 class="card-title">User Tools</h5>
      <p class="text-secondary">Basic actions available to all users.</p>
      <a href="#" class="btn btn-outline-info btn-sm disabled" aria-disabled="true">My Tickets (soon)</a>
    </div>
  </div>

  <div class="card bg-dark border-secondary shadow-sm mt-4" sec:authorize="hasRole('MANAGER')">
    <div class="card-body">
      <h5 class="card-title">Manager Tools</h5>
      <p class="text-secondary">Manage team workload and approvals.</p>
      <a href="#" class="btn btn-outline-warning btn-sm disabled" aria-disabled="true">Team Queue (soon)</a>
    </div>
  </div>

  <div class="card bg-dark border-secondary shadow-sm mt-4" sec:authorize="hasRole('ADMIN')">
    <div class="card-body">
      <h5 class="card-title">Admin Tools</h5>
      <p class="text-secondary">System-level configuration and reports.</p>
      <a href="#" class="btn btn-outline-danger btn-sm disabled" aria-disabled="true">Admin Console (soon)</a>
    </div>
  </div>

  <!-- Welcome/links -->
  <div class="row g-4 mt-1">
    <div class="col-12 col-xl-8">
      <div class="card bg-dark border-secondary shadow-sm">
        <div class="card-body">
          <h4 class="card-title mb-3">Welcome</h4>
          <p class="card-text">Hello, <span class="fw-semibold" th:text="${username}">user</span>!</p>
          <p class="mb-1 text-secondary">Your roles:</p>
          <div class="d-flex flex-wrap gap-2">
            <span th:if="${authorities == null}" class="badge text-bg-secondary">none</span>
            <span th:each="a : ${authorities}" class="badge text-bg-info">
              <span th:text="${a.authority}">ROLE_USER</span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4">
      <div class="card bg-dark border-secondary shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Quick Links</h5>
          <ul class="list-unstyled mb-0">
            <li class="mb-2"><a class="link-light link-underline-opacity-0" href="/health">Gateway Health</a></li>
            <li class="mb-2"><a class="link-light link-underline-opacity-0" href="/dashboard">Dashboard</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <div class="card bg-dark border-secondary shadow-sm mt-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Tickets</h5>
          <button id="btn-refresh" class="btn btn-outline-light btn-sm">Refresh</button>
        </div>
        <p class="text-secondary small mb-3">
          Data from ticket-service (http://localhost:8081/api/tickets)
        </p>

        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle mb-3" id="tickets-table">
            <thead>
            <tr>
              <th style="width:72px">ID</th>
              <th>Title</th>
              <th>Status</th>
              <th>Opened By</th>
              <th>Assigned To</th>
              <th>Created</th>
              <th style="width:220px">Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <!-- Create form -->
		<form id="create-ticket" class="row g-2" enctype="multipart/form-data">
		  <div class="col-md-4">
		    <input type="text" class="form-control bg-black text-light border-secondary" id="title" placeholder="Title" required>
		  </div>
		  <div class="col-md-4">
		    <input type="text" class="form-control bg-black text-light border-secondary" id="description" placeholder="Description">
		  </div>
		  <div class="col-md-4">
		    <input type="file" class="form-control bg-black text-light border-secondary" id="attachment" accept="*/*">
		  </div>
		  <div class="col-12 d-grid">
		    <button class="btn btn-info" type="submit">Create Ticket</button>
		  </div>
		</form>

        <div id="tickets-alert" class="text-secondary small mt-2"></div>
      </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>
<script>
  (function () {
    const API_BASE = "http://localhost:8081/api/tickets";
    const STATUSES = ["SUBMITTED","APPROVED","REJECTED","IN_PROGRESS","RESOLVED","REOPENED","CLOSED"];

    const $tableBody = $("#tickets-table tbody");
    const $alert = $("#tickets-alert");
    const $btnRefresh = $("#btn-refresh");
    const $form = $("#create-ticket");
    const $title = $("#title");
    const $description = $("#description");
	
	function isManager() { return hasRole("ROLE_MANAGER"); }
	function canApproveReject(ticket) {
	  return isManager() && (ticket.status === "SUBMITTED");
	}
	
	// derive roles from badges that Thymeleaf rendered
	  function getRolesFromPage() {
	    const badges = Array.from(document.querySelectorAll('[th\\:each="a : ${authorities}"], .badge'))
	      .map(b => b.textContent?.trim())
	      .filter(Boolean);
	    // Expect ROLE
	    return badges.filter(x => x.startsWith('ROLE_'));
	  }
	  function hasRole(r) { return getRolesFromPage().includes(r); }

    function fmt(ts) {
      if (!ts) return "";
      try { return new Date(ts).toLocaleString(); } catch { return ts; }
    }
	
	function addIdentityHeaders(xhr) {
	  const user = document.getElementById("username")?.textContent || "user";
	  const roles = getRolesFromPage().join(","); //"ROLE_USER,ROLE_MANAGER"
	  xhr.setRequestHeader("X-User", user);
	  xhr.setRequestHeader("X-Roles", roles);
	}

    function setAlert(msg, isError) {
      $alert.toggleClass("text-danger", !!isError)
            .toggleClass("text-secondary", !isError)
            .text(msg || "");
    }

    function optionList(current) {
      return STATUSES.map(s => `<option value="${s}" ${s===current ? "selected":""}>${s}</option>`).join("");
    }

	function actionCell(ticket) {
	  if (canApproveReject(ticket)) {
	    const ph = `Note (optional)`;
	    return `
	      <div class="d-flex flex-wrap gap-2 align-items-center">
	        <input type="text" class="form-control form-control-sm bg-black text-light border-secondary note-input"
	               data-id="${ticket.id}" placeholder="${ph}" style="max-width: 220px;">
	        <button class="btn btn-success btn-sm btn-approve" data-id="${ticket.id}">Approve</button>
	        <button class="btn btn-outline-danger btn-sm btn-reject" data-id="${ticket.id}">Reject</button>
	      </div>
	    `;
	  }
	  // default (existing) status dropdown + Apply
	  return `
	    <div class="d-flex gap-2 align-items-center">
	      <select class="form-select form-select-sm bg-black text-light border-secondary status-select"
	              data-id="${ticket.id}">
	        ${optionList(ticket.status)}
	      </select>
	      <button class="btn btn-outline-info btn-sm apply-status" data-id="${ticket.id}">Apply</button>
	    </div>
	  `;
	}


    function render(rows) {
      $tableBody.empty();
      if (!rows || rows.length === 0) {
        $tableBody.append(`<tr><td colspan="7" class="text-center text-secondary">No tickets yet</td></tr>`);
        return;
      }
      rows.forEach(t => {
        $tableBody.append(`
          <tr data-id="${t.id}">
            <td>${t.id ?? ""}</td>
            <td>${t.title ?? ""}</td>
            <td><span class="badge text-bg-info">${t.status ?? ""}</span></td>
            <td>${t.openedBy ?? ""}</td>
            <td>${t.assignedTo ?? ""}</td>
            <td>${fmt(t.createdAt)}</td>
            <td>${actionCell(t)}</td>
          </tr>
        `);
      });
    }
	
	function currentUsername() {
	  return document.getElementById("username")?.textContent || "manager";
	}

	function approveTicket(id, note) {
	  setAlert(`Approving ticket #${id}â€¦`);
	  $.ajax({
	    url: `${API_BASE}/${id}/approve?by=${encodeURIComponent(currentUsername())}&note=${encodeURIComponent(note || "")}`,
	    method: "PATCH",
	    beforeSend: addIdentityHeaders
	  }).done(() => {
	    setAlert(`Approved ticket #${id}.`);
	    loadTickets();
	  }).fail(xhr => {
	    const msg = xhr.responseJSON?.message || xhr.responseText || `${xhr.status} ${xhr.statusText}`;
	    setAlert(`Failed to approve: ${msg}`, true);
	  });
	}
	
	function isAdmin()   { return hasRole("ROLE_ADMIN"); }
	function isManager() { return hasRole("ROLE_MANAGER"); }

	function canApproveReject(ticket) {
	  // Only managers, and only when ticket is SUBMITTED
	  return isManager() && (ticket.status === "SUBMITTED");
	}


	function rejectTicket(id, note) {
	  setAlert(`Rejecting ticket #${id}â€¦`);
	  $.ajax({
	    url: `${API_BASE}/${id}/reject?by=${encodeURIComponent(currentUsername())}&note=${encodeURIComponent(note || "")}`,
	    method: "PATCH",
	    beforeSend: addIdentityHeaders
	  }).done(() => {
	    setAlert(`Rejected ticket #${id}.`);
	    loadTickets();
	  }).fail(xhr => {
	    const msg = xhr.responseJSON?.message || xhr.responseText || `${xhr.status} ${xhr.statusText}`;
	    setAlert(`Failed to reject: ${msg}`, true);
	  });
	}


    function loadTickets() {
      setAlert("Loading ticketsâ€¦");
      $.ajax({ 
		url: API_BASE, 
		method: "GET",
		beforeSend: addIdentityHeaders })
        .done(data => {
          render(data);
          setAlert(`Loaded ${Array.isArray(data) ? data.length : 0} ticket(s).`);
        })
        .fail(xhr => setAlert(`Failed to load tickets: ${xhr.status} ${xhr.statusText}`, true));
    }

	function createTicket(evt) {
	  evt.preventDefault();
	  const fd = new FormData();
	  const titleVal = $("#title").val();
	  const descVal  = $("#description").val();
	  const file     = $("#attachment")[0].files[0];
	  const openedBy = document.getElementById("username")?.textContent;

	  if (!titleVal || titleVal.trim() === "") {
	    setAlert("Title is required.", true);
	    return;
	  }

	  fd.append("title", titleVal);
	  if (descVal)  fd.append("description", descVal);
	  if (openedBy) fd.append("openedBy", openedBy);
	  if (file)     fd.append("file", file);

	  setAlert("Creating ticketâ€¦");
	  $.ajax({
	    url: API_BASE,
	    method: "POST",
	    data: fd,
	    processData: false,
	    contentType: false,
		beforeSend: addIdentityHeaders
		  }).done(() => {
	    $("#title").val(""); $("#description").val(""); $("#attachment").val("");
	    setAlert("Ticket created.");
	    loadTickets();
	  }).fail(xhr => {
	    const msg = xhr.responseJSON?.message || xhr.responseText || `${xhr.status} ${xhr.statusText}`;
	    setAlert(`Failed to create ticket: ${msg}`, true);
	  });
	}
	
	function updateStatus(id, status) {
	  const by = encodeURIComponent(currentUsername() || "system");

	  // Managers use the dedicated endpoints
	  if (status === "APPROVED" || status === "REJECTED") {
	    if (!isManager()) { setAlert("Only managers can approve/reject.", true); return; }
	    if (status === "APPROVED") { approveTicket(id, ""); return; }
	    if (status === "REJECTED") { rejectTicket(id, ""); return; }
	  }

	  setAlert(`Updating ticket #${id} â†’ ${status}â€¦`);
	  $.ajax({
	    url: `${API_BASE}/${id}/status?status=${encodeURIComponent(status)}&by=${by}`,
	    method: "PATCH",
	    beforeSend: addIdentityHeaders
	  })
	  .done(() => { setAlert(`Updated ticket #${id} to ${status}.`); loadTickets(); })
	  .fail(xhr => {
	    const msg = xhr.responseJSON?.message || xhr.responseText || `${xhr.status} ${xhr.statusText}`;
	    setAlert(`Failed to update status: ${msg}`, true);
	  });
	}
	
	function actionCell(ticket) {
	  if (canApproveReject(ticket)) {
	    const ph = `Note (optional)`;
	    return `
	      <div class="d-flex flex-wrap gap-2 align-items-center">
	        <input type="text" class="form-control form-control-sm bg-black text-light border-secondary note-input"
	               data-id="${ticket.id}" placeholder="${ph}" style="max-width: 220px;">
	        <button class="btn btn-success btn-sm btn-approve" data-id="${ticket.id}">Approve</button>
	        <button class="btn btn-outline-danger btn-sm btn-reject" data-id="${ticket.id}">Reject</button>
	      </div>
	    `;
	  }
	  // Everyone else: just the dropdown (without APPROVED/REJECTED for non-managers)
	  return `
	    <div class="d-flex gap-2 align-items-center">
	      <select class="form-select form-select-sm bg-black text-light border-secondary status-select"
	              data-id="${ticket.id}">
	        ${optionList(ticket.status)}
	      </select>
	      <button class="btn btn-outline-info btn-sm apply-status" data-id="${ticket.id}">Apply</button>
	    </div>
	  `;
	}

	
	function allowedTargetsForUser() {
	  const canMgr  = hasRole("ROLE_MANAGER");
	  const canAdm  = hasRole("ROLE_ADMIN");
	  return [
	    "OPEN",
	    ...(canMgr ? ["IN_PROGRESS"] : []),
	    ...(canAdm ? ["RESOLVED","CLOSED"] : [])
	  ];
	}

    // Event wiring
    $btnRefresh.on("click", loadTickets);
    $form.on("submit", createTicket);

    // Event delegation for per-row actions
    $tableBody.on("click", ".apply-status", function () {
      const id = $(this).data("id");
      const sel = $tableBody.find(`select.status-select[data-id="${id}"]`);
      const status = sel.val();
      updateStatus(id, status);
    });
	
	// Approve
	$tableBody.on("click", ".btn-approve", function () {
	  const id = $(this).data("id");
	  const note = $tableBody.find(`.note-input[data-id="${id}"]`).val();
	  approveTicket(id, note);
	});

	// Reject
	$tableBody.on("click", ".btn-reject", function () {
	  const id = $(this).data("id");
	  const note = $tableBody.find(`.note-input[data-id="${id}"]`).val();
	  rejectTicket(id, note);
	});

    // Initial load
    $(loadTickets);
  })();
</script>
</body>
</html>
